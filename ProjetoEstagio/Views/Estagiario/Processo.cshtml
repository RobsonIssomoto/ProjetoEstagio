@* MUDANÇA 1: Usar o novo ViewModel *@
@model ProjetoEstagio.Models.ViewModels.SolicitacaoCadastroViewModel
@{
    Layout = "_LayoutEstagiario";
    ViewData["Title"] = "Processo Estagiário";
}

<form asp-controller="Estagiario" asp-action="CriarSolicitacao" method="post">

    <input type="hidden" asp-for="EstagiarioId" />

    <div class="row justify-content-center ">
        <div class="col-6 col-md-8" style="min-width: 380px">
            <div class="card-header border-0 text-center mt-3">
                <h5 class="mb-0 text-center fw-bold ">
                    Início do Processo
                </h5>
                <p class="text-center text-muted mb-4">Preencha as informações a seguir sobre o estágio</p>
            </div>

            <div class="card mb-4 shadow-sm">
                <div class="card-header text-center">
                    <h5 class="mb-0">Dados Pessoais</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label" asp-for="EstagiarioNome">Nome</label>
                            <input type="text" class="form-control  bg-light" asp-for="EstagiarioNome" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" asp-for="EstagiarioCurso">Curso</label>
                            <input type="text" class="form-control  bg-light" asp-for="EstagiarioCurso" readonly />
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4 shadow-sm">
                <div class="card-header text-center">
                    <h5 class="mb-0">Dados da Empresa</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Pesquisar Nome da Empresa</label>
                            <input type="search" class="form-control mb-2"
                                   placeholder="Pesquisar por nome ou CNPJ"
                                   id="busca-empresa-input"
                                   autocomplete="off" />

                            <div id="busca-empresa-resultados" class="list-group">
                            </div>
                            <input type="hidden" asp-for="EmpresaId" id="empresa-id-selecionada" /> 
                            <a href="#" class="small mt-2 d-block" id="btn-convidar-empresa">
                                Enviar convite para cadastro de empresa
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4 shadow-sm">
                <div class="card-header text-center">
                    <h5 class="mb-0">Observações</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label" asp-for="Observacao">Dados Adicionais (opcional)</label>
                            <textarea class="form-control" asp-for="Observacao" rows="5" placeholder="Inclua informações adicionais, se necessário"></textarea> 
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex flex-column gap-2 my-2">
                <button type="submit" class="btn btn-primary w-100">Enviar</button>
                <a class="btn btn-outline-secondary w-100" asp-controller="Home" asp-action="Index">Cancelar</a>
            </div>

        </div>
    </div>
</form>

@section Scripts {
    <script>
        $(document).ready(function () {

            var $inputBusca = $('#busca-empresa-input');
            var $resultadosBusca = $('#busca-empresa-resultados');
            var $campoEmpresaId = $('#empresa-id-selecionada');


            $inputBusca.on('keyup', function () {
                var termo = $(this).val();

                if (termo.length < 3) {
                    $resultadosBusca.empty();
              return;
                }

                // Chama a Action no EmpresaController
                $.ajax({
                    url: '@Url.Action("BuscarEmpresas", "Empresa")',
                    data: { termoDeBusca: termo },
                    success: function (data) {
                        $resultadosBusca.empty();

                        if (data.length > 0) {
                            $.each(data, function (i, empresa) {
                                var item = $('<a href="#" class="list-group-item list-group-item-action"></a>');
                                item.text(empresa.nome + ' (' + empresa.cnpj + ')');
                                item.data('id', empresa.id); // Armazena o ID no item
                                item.data('nome', empresa.nome); // Armazena o nome
                                $resultadosBusca.append(item);
                           });
                        } else {
                            $resultadosBusca.append('<span class="list-group-item text-muted">Nenhuma empresa encontrada.</span>');
                  }
                    }
                });
          });

            // 2. Ação de clique no resultado
            $resultadosBusca.on('mousedown', '.list-group-item-action', function (e) {
                e.preventDefault();

             var idSelecionado = $(this).data('id');
                var nomeSelecionado = $(this).data('nome');

                // Preenche os campos
                $campoEmpresaId.val(idSelecionado);
                $inputBusca.val(nomeSelecionado); // Coloca o nome limpo no input

              // Limpa os resultados
                $resultadosBusca.empty();
            });
            // 3. Lógica de 'blur' (limpar)
            $inputBusca.on('blur', function() {
                if ($(this).val() === '') {
                  $campoEmpresaId.val('');
                }
            });
        });
    </script>
}
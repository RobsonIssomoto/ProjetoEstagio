@* MUDANÇA 1: Usar o novo ViewModel *@
@model ProjetoEstagio.Models.ViewModels.SolicitacaoCadastroViewModel
@{
    Layout = "_LayoutEstagiario";
    ViewData["Title"] = "Processo Estagiário";
}

@* MUDANÇA 2: Apontar para uma Action específica, ex: "CriarSolicitacao" *@
<form asp-controller="Estagiario" asp-action="CriarSolicitacao" method="post">

    @* MUDANÇA 3: Enviar o ID do Estagiário de forma oculta *@
    <input type="hidden" asp-for="EstagiarioId" />

    <div class="row justify-content-center ">
        <div class=" card col-12 col-sm-8 bg-white p-4 rounded shadow ">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0 text-center fw-bold ">
                    Início do Processo
                </h5>
                <p class="text-center text-muted mb-4">Preencha as informações a seguir sobre o estágio</p>
            </div>

            <div class="card mb-4 shadow-sm">
                <div class="card-header text-center">
                    <h5 class="mb-0">Dados Pessoais</h5>
                </div>
                <div class="card-body">
                    <label class="form-label">Nome</label>
                    @* MUDANÇA 4: Usar as propriedades do ViewModel *@
                    <input type="text" class="form-control mb-3" asp-for="EstagiarioNome" readonly />

                    <label class="form-label">Curso</label>
                    <input type="text" class="form-control" asp-for="EstagiarioCurso" readonly />
                </div>
            </div>

            <div class="card mb-4 shadow-sm">
                <div class="card-header text-center">
                    <h5 class="mb-0">Dados da Empresa</h5>
                </div>
                <div class="card-body">
                    <label class="form-label">Pesquisar Nome da Empresa</label>
                    <input type="search" class="form-control mb-2"
                           placeholder="Pesquisar por nome ou CNPJ"
                           id="busca-empresa-input"
                           autocomplete="off" />

                    <div id="busca-empresa-resultados" class="list-group">
                    </div>

                    @* MUDANÇA 5: Vincular o ID da empresa ao ViewModel *@
                    <input type="hidden" asp-for="EmpresaId" id="empresa-id-selecionada" />

                    <a href="#" class="small mt-2 d-block" id="btn-convidar-empresa">
                        Enviar convite para cadastro de empresa
                    </a>

                    @* (Aqui você pode adicionar um modal que preencha o "EmailConvite") *@
                </div>
            </div>

            <div class="card mb-4 shadow-sm">
                <div class="card-header text-center">
                    <h5 class="mb-0">Observações</h5>
                </div>
                <div class="card-body">
                    <label class="form-label">Dados Adicionais (opcional)</label>
                    @* MUDANÇA 6: Vincular o textarea ao ViewModel *@
                    <textarea class="form-control" asp-for="Observacao" rows="5" placeholder="Inclua informações adicionais, se necessário"></textarea>
                </div>
            </div>
            <div class="d-flex flex-column gap-2 my-2">
                <button type="submit" class="btn btn-danger w-100">Enviar</button>
                <a class="btn btn-outline-secondary w-100" asp-controller="Home" asp-action="Index">Cancelar</a>
            </div>
        </div>
    </div>
</form>
@section Scripts {
    <script>
        $(document).ready(function () {

            var $inputBusca = $('#busca-empresa-input');
            var $resultadosBusca = $('#busca-empresa-resultados');
            var $campoEmpresaId = $('#empresa-id-selecionada');

            // 1. Ação de busca (AJAX)
            $inputBusca.on('keyup', function () {
                var termo = $(this).val();

                if (termo.length < 3) {
                    $resultadosBusca.empty();
                    return;
                }

                // Chama a Action no EmpresaController
                $.ajax({
                    url: '@Url.Action("BuscarEmpresas", "Empresa")',
                    data: { termoDeBusca: termo },
                    success: function (data) {
                        $resultadosBusca.empty();

                        if (data.length > 0) {
                            $.each(data, function (i, empresa) {
                                var item = $('<a href="#" class="list-group-item list-group-item-action"></a>');
                                item.text(empresa.nome + ' (' + empresa.cnpj + ')');
                                item.data('id', empresa.id); // Armazena o ID no item
                                item.data('nome', empresa.nome); // Armazena o nome
                                $resultadosBusca.append(item);
                            });
                        } else {
                            $resultadosBusca.append('<span class="list-group-item text-muted">Nenhuma empresa encontrada.</span>');
                        }
                    }
                });
            });

            // 2. Ação de clique no resultado
            // MUDANÇA AQUI: Usamos 'mousedown' em vez de 'click'
            // 'mousedown' dispara antes de 'blur', resolvendo o problema sem 'setTimeout'
            $resultadosBusca.on('mousedown', '.list-group-item-action', function (e) {
                e.preventDefault(); // Impede o link de navegar E de roubar o foco

                var idSelecionado = $(this).data('id');
                var nomeSelecionado = $(this).data('nome');

                // Preenche os campos
                $campoEmpresaId.val(idSelecionado);
                $inputBusca.val(nomeSelecionado); // Coloca o nome limpo no input

                // Limpa os resultados
                $resultadosBusca.empty();
            });

            // 3. Lógica de 'blur' (limpar)
            // Esta lógica agora funciona, pois o 'mousedown' já preencheu o campo
            $inputBusca.on('blur', function() {
                // Se o usuário sair do campo e ele estiver vazio, limpa o ID
                if ($(this).val() === '') {
                    $campoEmpresaId.val('');
                }
            });

        });
    </script>
}